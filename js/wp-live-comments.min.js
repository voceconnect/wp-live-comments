(function(e,t,n){var r=n.ajaxUrl||"",i=n.post_id||0,s=n.since_id||0,o=function(){var e=function(){that=this,jQuery(".popup .close").on("click",function(){that.popup.hide(this)})};return e.prototype={constructor:e,popup:new TINYPOP({position:"center",sticky:!0})},e}(),u=Backbone.Model.extend({idAttribute:"comment_ID"}),a=t.template(e("script#wp-live-comment-template").html()),f=Backbone.Collection.extend({model:u,since_id:0,initialize:function(){this.since_id=s},_setSinceID:function(e){e.length&&(this.since_id=t.max(t.pluck(e,"comment_ID")))},url:function(){return r+"?"+e.param({action:"json_comments",post_id:i,since_id:this.since_id})},parse:function(e){return this._setSinceID(e),e}}),l=Backbone.View.extend({tagName:"li",attributes:{"class":"comment"},events:{"click a.comment-reply-link":"reply"},reply:function(){return addComment.moveForm("comment-"+this.model.id,this.model.id,"respond",i),!1},render:function(){return this.$el.addClass(this.model.get("comment_class")),this.$el.html(a(this.model.toJSON())),this}}),c=Backbone.View.extend({el:"#comments ol.commentlist",_commentViews:[],initialize:function(){this.collection.on("add",this.add,this),this.collection.on("reset",this.reset,this),this.notifications=new o},add:function(e){var n=new l({model:e});this._commentViews.push(n);var r=parseInt(e.get("comment_parent"));if(!isNaN(r)&&r>0){var i=t.filter(this._commentViews,function(e){return r===parseInt(e.model.id)}).pop();if("undefined"!=typeof i){i.$("> ul.children").append(n.render().el);return}}this.$el.append(n.render().el)},reset:function(e){t.map(e.models,this.add,this)}}),h=new f;window.bbLiveComments=h;var p=new c({collection:h});t.isArray(n.comments)&&h.reset(n.comments),setInterval(function(){var t={add:!0};e.browser.msie&&(t.cache=!1),h.fetch(t)},2e3);var d=e("#commentform"),v=e("#comment-form-error"),m=function(e){v.html(e)};d.ajaxForm({dataType:"json",beforeSubmit:function(t,n,r){var i=n.find(':input[aria-required="true"]').filter(function(){return e.trim(e(this).val())===""});if(i.length>0)return m("Please fill out all required fields."),!1},success:function(t){"undefined"==typeof t.error&&(h.add(t),p.notifications.popup.show("Comment Posted"),d.clearForm(),e("#cancel-comment-reply-link").click()),m(t.error||"")},error:function(){m("There was an error processing your request.")}})})(jQuery,_,window.wpLiveCommentsInit||{});