(function(e,t,n){var r=n.ajaxUrl||"",i=n.post_id||0,s=n.since_id||0,o=Backbone.Model.extend({idAttribute:"comment_ID"}),u=t.template(e("script#wp-live-comment-template").html()),a=Backbone.Collection.extend({model:o,since_id:0,initialize:function(){this.since_id=s},_setSinceID:function(e){e.length&&(this.since_id=t.max(t.pluck(e,"comment_ID")))},url:function(){return r+"?"+e.param({action:"json_comments",post_id:i,since_id:this.since_id})},parse:function(e){return this._setSinceID(e),e}}),f=Backbone.View.extend({tagName:"li",attributes:{"class":"comment"},events:{"click a.comment-reply-link":"reply"},reply:function(){return addComment.moveForm("comment-"+this.model.id,this.model.id,"respond",i),!1},render:function(){return this.$el.addClass(this.model.get("comment_class")),this.$el.html(u(this.model.toJSON())),this}}),l=Backbone.View.extend({el:"#comments ol.commentlist",_commentViews:[],initialize:function(){this.collection.on("add",this.add,this),this.collection.on("reset",this.reset,this)},add:function(e){var n=new f({model:e});this._commentViews.push(n);var r=parseInt(e.get("comment_parent"));if(!isNaN(r)&&r>0){var i=t.filter(this._commentViews,function(e){return r===parseInt(e.model.id)}).pop();if("undefined"!=typeof i){i.$("> ul.children").append(n.render().el);return}}this.$el.append(n.render().el)},reset:function(e){t.map(e.models,this.add,this)}}),c=new a;window.bbLiveComments=c;var h=new l({collection:c});t.isArray(n.comments)&&c.reset(n.comments),setInterval(function(){var t={add:!0};e.browser.msie&&(t.cache=!1),c.fetch(t)},2e3);var p=e("#commentform"),d=e("#comment-form-error"),v=function(e){d.html(e)};p.ajaxForm({dataType:"json",beforeSubmit:function(t,n,r){var i=n.find(':input[aria-required="true"]').filter(function(){return e.trim(e(this).val())===""});if(i.length>0)return v("Please fill out all required fields."),!1},success:function(t){"undefined"==typeof t.error&&(c.add(t),p.clearForm(),e("#cancel-comment-reply-link").click()),v(t.error||"")},error:function(){v("There was an error processing your request.")}})})(jQuery,_,window.wpLiveCommentsInit||{});